"use strict";var _fileicon=_interopRequireDefault(require("@aslamhus/fileicon"));Object.defineProperty(exports,"__esModule",{value:!0}),exports["default"]=void 0,require("core-js/stable"),require("regenerator-runtime/runtime");function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _getRequireWildcardCache(a){if("function"!=typeof WeakMap)return null;var b=new WeakMap,c=new WeakMap;return(_getRequireWildcardCache=function(a){return a?c:b})(a)}function _interopRequireWildcard(a,b){if(!b&&a&&a.__esModule)return a;if(null===a||"object"!==_typeof(a)&&"function"!=typeof a)return{default:a};var c=_getRequireWildcardCache(b);if(c&&c.has(a))return c.get(a);var d={},e=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var f in a)if("default"!=f&&Object.prototype.hasOwnProperty.call(a,f)){var g=e?Object.getOwnPropertyDescriptor(a,f):null;g&&(g.get||g.set)?Object.defineProperty(d,f,g):d[f]=a[f]}return d["default"]=a,c&&c.set(a,d),d}function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_unsupportedIterableToArray(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=Array(b);c<b;c++)d[c]=a[c];return d}function _iterableToArrayLimit(a,b){var c=null==a?null:"undefined"!=typeof Symbol&&a[Symbol.iterator]||a["@@iterator"];if(null!=c){var d,e,f=[],g=!0,h=!1;try{for(c=c.call(a);!(g=(d=c.next()).done)&&(f.push(d.value),!(b&&f.length===b));g=!0);}catch(a){h=!0,e=a}finally{try{g||null==c["return"]||c["return"]()}finally{if(h)throw e}}return f}}function _arrayWithHoles(a){if(Array.isArray(a))return a}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}var FileSelect=/*#__PURE__*/function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"*",c=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{fileInput:!0,onReaderProgress:null,onReadFileComplete:null,onInvalidType:null,colors:null,theme:null};_classCallCheck(this,a),this.fileIcon=new _fileicon["default"]({colors:c.colors,theme:c.theme}),this.svg={default:"<svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"far\" data-icon=\"file\" class=\"svg-inline--fa fa-file fa-w-12\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 384 512\"><path fill=\"currentColor\" d=\"M369.9 97.9L286 14C277 5 264.8-.1 252.1-.1H48C21.5 0 0 21.5 0 48v416c0 26.5 21.5 48 48 48h288c26.5 0 48-21.5 48-48V131.9c0-12.7-5.1-25-14.1-34zM332.1 128H256V51.9l76.1 76.1zM48 464V48h160v104c0 13.3 10.7 24 24 24h104v288H48z\"></path></svg>"},this.validateArguments(b,c)}return _createClass(a,[{key:"validateArguments",value:function validateArguments(a,b){var c=b.fileInput;if(c){var d;this.fileInput=c,null!==(d=this.fileInput)&&void 0!==d&&d.tagName||(this.fileInput=document.querySelector(c)||document.querySelector("input[type=file]")||this.createFileInput())}// get allowed types
this.allowedTypes=a?a:"*"}},{key:"createFileInput",value:function createFileInput(){return this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.id=Date.now(),this.fileInput.style.display="none",this.fileInput.multiple="true",document.body.append(this.fileInput),this.fileInput}},{key:"fileSelected",value:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b){var c,d,e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return b.target?(b.stopPropagation(),b.preventDefault(),d=_slicedToArray(b.target.files,1),c=d[0],console.log("FileSelect - file",c)):c=b,a.next=3,this.handleFile(c,this.allowedTypes);case 3:if(e=a.sent,!e){a.next=6;break}return a.abrupt("return",!0);case 6:return a.abrupt("return",!0);case 7:case"end":return a.stop();}},a,this)}));return function fileSelected(){return a.apply(this,arguments)}}()},{key:"select",value:function select(){var a=this;return new Promise(function(b,c){a.fileInput||(console.error("Couldn't find file input element."),c(new Error("Invalid Argument Exception - no file element found."))),a.fileInput.onclick=function(a){return a.stopPropagation()},a.fileInput.onchange=function(a){var c=a.target.files;b(c)},a.fileInput.click()})}},{key:"getFiles",value:function getFiles(){if(!this.fileInput)throw new Error("There are no files to get");return this.fileInput.files}},{key:"readFiles",value:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b){var c,d=this;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=[],Object.values(b).forEach(function(a){c.push(d.handleFile(a,d.allowedTypes))}),a.next=4,Promise.all(c);case 4:return a.abrupt("return",c);case 5:case"end":return a.stop();}},a)}));return function readFiles(){return a.apply(this,arguments)}}()/**
   * Handle the image.
   * Summary.
   * 1) Add unique filename (re)Check the file types are valid.
   * 2) Read and return a file object with the data:URL.
   * @param {File} file
   *    - the file object to be handled. Must be instance of file
   * @param {String | String[]} allowedTypes
   *    - file types allowed. Example: [ 'image/jpeg', 'application/pdf' ]
   * @returns {Promise}
   *    - a promise that resolves when the file has been read.
   */},{key:"handleFile",value:function handleFile(a,b){var c=this;return new Promise(function(d,e){"object"===_typeof(a)&&a instanceof File||e(new Error("Invalid Argument Exception. Expected instance of file."));a.uuid=void 0===a.name?Date.now():a.name.replace(/(?=\.[^.]+$)/,"-".concat(Date.now()));// check filetype is allowed
var f=c.checkFileTypes(a,c.allowedTypes||b);f.valid||d(f),c.readFile(a,d,e)})}/**
   * Gets a blob URL for the selected file.
   * If the file is a PDF or a TEXT file, it returns a predetermined svg icon (as a blob url)
   * @param {file object} file  - a selected file from the file input.
   * @returns {Element} an element of the appropriate type (image, video, pdf)
   */},{key:"getPreview",value:function(){var b=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function b(c){var d,e,f,g,h,i,j,k,l,m,n,o,p;return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(c&&"object"===_typeof(c)&&c instanceof File){b.next=2;break}throw new Error("Type Error. getPreview expected file object");case 2:if(d={preview:null,icon:null},f=c.type.split("/"),g=_slicedToArray(f,2),h=g[0],i=g[1],"image/heic"!==c.type&&"image/heif"!==c.type){b.next=10;break}return b.next=7,a.getHEICBlob(c);case 7:e=b.sent,b.next=11;break;case 10:"image"===h||"video"===h||"audio"===h||"pdf"===i||"text/plain"===c.type?e=c:(console.log("unrecognized file type: ".concat(c.type)),e=c);case 11:j=c,e&&(j=URL.createObjectURL(e)),b.t0=h,b.next="application"===b.t0?16:"text"===b.t0?23:"video"===b.t0?33:"audio"===b.t0?36:"image"===b.t0?38:41;break;case 16:if("pdf"!==i){b.next=22;break}return b.next=19,a.getPDF(j);case 19:k=b.sent,b.next=22;break;case 22:return b.abrupt("break",41);case 23:if("plain"!==i){b.next=32;break}return b.next=26,c.text();case 26:l=b.sent,k=document.createElement("div"),k.style.padding="15px",k.textContent=l,b.next=32;break;case 32:return b.abrupt("break",41);case 33:return k=document.createElement("video"),k.src=j,b.abrupt("break",41);case 36:return k=a.createAudioElement(j,c.type),b.abrupt("break",41);case 38:return k=document.createElement("img"),k.src=j,b.abrupt("break",41);case 41:if(k&&"audio"!==h&&(k.onload=URL.revokeObjectURL(j)),n=a.getExtensionFromFilename(c.name),!(this.svg.hasOwnProperty("default")||this.svg.hasOwnProperty(h))){b.next=53;break}return o=this.svg["default"]||this.svg[h],b.next=47,a.createSVGBlob(o);case 47:p=b.sent,m=document.createElement("img"),m.src=URL.createObjectURL(p),m.onload=URL.revokeObjectURL(p),b.next=56;break;case 53:return b.next=55,this.fileIcon.create(n);case 55:m=b.sent;case 56:return d.preview=k,d.icon=m,b.abrupt("return",d);case 59:case"end":return b.stop();}},b,this)}));return function getPreview(){return b.apply(this,arguments)}}()},{key:"checkFileTypes",value:function checkFileTypes(a,b){var c=a.type;if("*"===b)return{valid:!0};var d=this.getTypeList(b||this.allowedTypes),e=c.split("/")[0];return d.types.includes("".concat(e,"/*"))?{valid:!0}:(d.types.includes(c)?d.valid=!0:(d.valid=!1,this.onInvalidType instanceof Function?this.onInvalidType.call(d,d.message):console.error(d.message)),d)}},{key:"readFile",value:function readFile(a,b,c){var d,g=this,h=new FileReader;h.onprogress=function(b){g.progress(b,a)},h.onload=function(a){return function(c){var e=c.target.result;d={name:a.name,type:a.type,size:a.size,uuid:a.uuid,data:e},g.readFileComplete(d),b(d)}}(a),h.onerror=function(a){var b;switch(a.target.error.code){case a.target.error.NOT_FOUND_ERR:b="File not found!";break;case a.target.error.NOT_READABLE_ERR:b="File not readable!";break;case a.target.error.ABORT_ERR:b="Read operation was aborted!";break;case a.target.error.SECURITY_ERR:b="File is in a locked state!";break;case a.target.error.ENCODING_ERR:b="The file is too long to encode in a \"data://\" URL.";break;default:b="Read error.";}console.error("Read File Error:",b),c(b)},h.readAsDataURL(a)}},{key:"progress",value:function progress(a,b){this.onReaderProgress instanceof Function&&this.onReaderProgress.call(b,a)}},{key:"readFileComplete",value:function readFileComplete(a){this.onFileReadComplete instanceof Function&&this.onFileReadComplete.call(this,a)}}],[{key:"createAudioElement",value:function createAudioElement(a,b){var c=document.createElement("audio");c.controls="controls",c.oncanplaythrough=function(){URL.revokeObjectURL(a)},c.onplay=function(){document.querySelectorAll("audio").forEach(function(a){a!==c&&a.pause()})};var d=document.createElement("source");return d.src=a,d.type=b,c.append(d),c}},{key:"getExtensionFromFilename",value:function getExtensionFromFilename(a){return a.match(/\.[0-9A-Z]+$/i)}},{key:"getHEICBlob",value:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function a(b){var c,d,e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,Promise.resolve().then(function(){return _interopRequireWildcard(require("heic2any"))});case 2:return c=a.sent,d=c["default"],a.next=6,d({blob:b,toType:"image/jpg"}).then(function(a){return a})["catch"](function(a){return console.error("Failed to get blob for heic file. Error: ".concat(a)),!1});case 6:return e=a.sent,a.abrupt("return",e);case 8:case"end":return a.stop();}},a)}));return function getHEICBlob(){return a.apply(this,arguments)}}()},{key:"createSVGBlob",value:function createSVGBlob(a){return new Promise(function(b){var c=new Blob([a],{type:"image/svg+xml"});b(c)})}},{key:"getPDF",value:function getPDF(a){return new Promise(function(b){return Promise.resolve().then(function(){return _interopRequireWildcard(require("pdfjs-dist/webpack"))}).then(function(c){if("undefined"==typeof c)throw new Error("couldn't initialize pdf.js library");var d=c.getDocument(a);d.promise.then(function(a){a.getPage(1).then(function(a){var c=a.getViewport({scale:1}),d=document.createElement("canvas");d.style.cssText="\n                          position:relative;\n                          width:100%;\n                          height:auto;\n                          margin:0px auto;\n                          top:50%;\n                          transform: translateY(-50%);";var e=d.getContext("2d");d.height=c.height,d.width=c.width;a.render({canvasContext:e,viewport:c}),b(d)})})})})}},{key:"getTypeList",value:function getTypeList(a){var b=a;"string"==typeof b&&(b=[b]);var c=b.map(function(a){return a}),d=[],e=[];0<c.length&&Object.values(c).forEach(function(a){d.push(a);var b=a.split("/");e.push(".".concat(b[1]))});var f=e.reduce(function(a,b,c){var d;return d=0===c?a+b:c===e.length-1?"".concat(a," or ").concat(b):"".concat(a,", ").concat(b),d},"File type must be ");return{message:f,types:d}}}]),a}(),_default=FileSelect;exports["default"]=_default;
